<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Cricket Match - Durham Women vs ZIM-W HP-XI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .match-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .match-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .match-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .match-venue, .match-date {
            font-size: 14px;
            color: #666;
        }
        
        .match-status {
            display: inline-block;
            padding: 5px 10px;
            background-color: #e74c3c;
            color: white;
            border-radius: 5px;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .teams-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .team {
            text-align: center;
            flex: 1;
        }
        
        .team-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .team-score {
            font-size: 24px;
            font-weight: bold;
        }
        
        .team-overs {
            font-size: 14px;
            color: #666;
        }
        
        .vs {
            font-size: 18px;
            margin: 0 20px;
        }
        
        .match-info {
            margin-bottom: 20px;
        }
        
        .match-info-item {
            margin-bottom: 10px;
        }
        
        .match-info-label {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .batters-container, .bowler-container {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            font-weight: bold;
            background-color: #f9f9f9;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
        }
        
        .error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
            font-size: 16px;
        }
        
        .refresh-container {
            text-align: center;
            margin-bottom: 20px;
        }
        
        #refresh-button {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        #refresh-button:hover {
            background-color: #2980b9;
        }
        
        .commentary-container {
            margin-top: 20px;
        }
        
        .commentary-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .commentary-over {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .required-rate {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .partnership-info {
            display: flex;
            justify-content: space-between;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .partnership-item {
            text-align: center;
        }
        
        .partnership-value {
            font-size: 18px;
            font-weight: bold;
        }
        
        .partnership-label {
            font-size: 12px;
            color: #666;
        }
        
        .recent-overs {
            display: flex;
            overflow-x: auto;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }
        
        .over-box {
            min-width: 120px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-right: 10px;
            padding: 8px;
        }
        
        .over-number {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .over-details {
            font-size: 14px;
            letter-spacing: 5px;
        }
        
        .over-runs {
            font-weight: bold;
            margin-top: 5px;
        }
        
        .refresh-status {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        
        /* New styles for innovative visualizations */
        .visualizations-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .visualization-card {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
        }
        
        .visualization-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }
        
        .win-probability-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
            background-color: #f5f5f5;
            border-radius: 20px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .team1-probability, .team2-probability {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .team1-probability {
            background-color: #3498db;
            border-radius: 20px 0 0 20px;
        }
        
        .team2-probability {
            background-color: #e74c3c;
            border-radius: 0 20px 20px 0;
            text-align: right;
        }
        
        .run-rate-comparison {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
        }
        
        .run-rate-item {
            flex: 1;
            text-align: center;
        }
        
        .run-rate-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .run-rate-label {
            font-size: 12px;
            color: #666;
        }
        
        .wickets-timeline {
            position: relative;
            height: 60px;
            background-color: #f5f5f5;
            border-radius: 5px;
            margin: 15px 0;
            padding: 10px 0;
        }
        
        .timeline-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #ccc;
            transform: translateY(-50%);
        }
        
        .wicket-marker {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background-color: #e74c3c;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }
        
        .wicket-tooltip {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            display: none;
        }
        
        .wicket-marker:hover .wicket-tooltip {
            display: block;
        }
        
        .manhattan-chart {
            display: flex;
            align-items: flex-end;
            height: 150px;
            gap: 2px;
        }
        
        .manhattan-bar {
            flex: 1;
            background-color: #3498db;
            min-width: 15px;
            position: relative;
            cursor: pointer;
        }
        
        .manhattan-bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
        }
        
        .manhattan-bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
        }
        
        .wagon-wheel-container {
            position: relative;
            width: 100%;
            height: 200px;
        }
        
        .wagon-wheel-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            height: 150px;
            border: 2px solid #ccc;
            border-radius: 50%;
        }
        
        .wagon-wheel-shot {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            background-color: #3498db;
            transform-origin: 0 0;
        }
        
        .wagon-wheel-boundary {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            background-color: #e74c3c;
            transform-origin: 0 0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .teams-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .vs {
                margin: 10px 0;
            }
            
            .visualizations-container {
                flex-direction: column;
            }
            
            .visualization-card {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-title">Live Cricket Match</h1>
        
        <div class="refresh-controls">
            <div class="refresh-info">
                <span>Auto-refresh: <span id="refresh-interval">30</span>s</span>
            </div>
            <div class="refresh-buttons">
                <button class="interval-button" data-interval="10">10s</button>
                <button class="interval-button active" data-interval="30">30s</button>
                <button class="interval-button" data-interval="60">60s</button>
                <button id="refresh-button">Refresh Now</button>
            </div>
        </div>
        <p id="refresh-status" class="refresh-status" style="display: none;"></p>
        
        <div id="match-container" class="match-card">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Loading match data...</p>
            </div>
            
            <div id="error" class="error-message" style="display: none;"></div>
            
            <div id="match-content" style="display: none;">
                <div class="match-header">
                    <div class="match-title" id="match-title"></div>
                    <div class="match-venue" id="match-venue"></div>
                    <div class="match-date" id="match-date"></div>
                    <div class="match-status" id="match-status"></div>
                </div>
                
                <div class="teams-container">
                    <div class="team">
                        <div class="team-name" id="team1-name"></div>
                        <div class="team-score" id="team1-score"></div>
                        <div class="team-overs" id="team1-overs"></div>
                    </div>
                    <div class="vs">vs</div>
                    <div class="team">
                        <div class="team-name" id="team2-name"></div>
                        <div class="team-score" id="team2-score"></div>
                        <div class="team-overs" id="team2-overs"></div>
                    </div>
                </div>
                
                <!-- New Visualizations Section -->
                <div class="visualizations-container">
                    <!-- Win Probability -->
                    <div class="visualization-card">
                        <div class="visualization-title">Win Probability</div>
                        <div class="win-probability-container">
                            <div class="team1-probability" id="team1-win-prob"></div>
                            <div class="team2-probability" id="team2-win-prob"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span id="team1-short"></span>
                            <span id="team2-short"></span>
                        </div>
                    </div>
                    
                    <!-- Run Rate Comparison -->
                    <div class="visualization-card">
                        <div class="visualization-title">Run Rate Analysis</div>
                        <div class="run-rate-comparison">
                            <div class="run-rate-item">
                                <div class="run-rate-value" id="current-rr">0.00</div>
                                <div class="run-rate-label">Current RR</div>
                            </div>
                            <div class="run-rate-item">
                                <div class="run-rate-value" id="required-rr">0.00</div>
                                <div class="run-rate-label">Required RR</div>
                            </div>
                            <div class="run-rate-item">
                                <div class="run-rate-value" id="projected-score">0</div>
                                <div class="run-rate-label">Projected</div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="runRateChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="visualizations-container">
                    <!-- Manhattan Chart (Over-by-Over Runs) -->
                    <div class="visualization-card">
                        <div class="visualization-title">Manhattan Chart (Runs per Over)</div>
                        <div class="chart-container">
                            <canvas id="manhattanChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Wickets Timeline -->
                    <div class="visualization-card">
                        <div class="visualization-title">Wickets Timeline</div>
                        <div class="wickets-timeline" id="wickets-timeline">
                            <div class="timeline-line"></div>
                            <!-- Wicket markers will be added dynamically -->
                        </div>
                        <div class="chart-container">
                            <canvas id="wicketsChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="match-info">
                    <div class="match-info-item" id="toss-info"></div>
                    <div class="match-info-item" id="target-info"></div>
                </div>
                
                <div class="section-title">Current Batters</div>
                <div class="batters-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Batter</th>
                                <th>Runs</th>
                                <th>Balls</th>
                                <th>4s</th>
                                <th>6s</th>
                                <th>SR</th>
                            </tr>
                        </thead>
                        <tbody id="batters-table"></tbody>
                    </table>
                </div>
                
                <div class="section-title">Current Bowler</div>
                <div class="bowler-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Bowler</th>
                                <th>Overs</th>
                                <th>Maidens</th>
                                <th>Runs</th>
                                <th>Wickets</th>
                                <th>Economy</th>
                            </tr>
                        </thead>
                        <tbody id="bowler-table"></tbody>
                    </table>
                </div>
                
                <div class="section-title">Partnership</div>
                <div class="partnership-info">
                    <div class="partnership-item">
                        <div class="partnership-value" id="partnership-runs">0</div>
                        <div class="partnership-label">Runs</div>
                    </div>
                    <div class="partnership-item">
                        <div class="partnership-value" id="partnership-balls">0</div>
                        <div class="partnership-label">Balls</div>
                    </div>
                    <div class="partnership-item">
                        <div class="partnership-value" id="partnership-rate">0.00</div>
                        <div class="partnership-label">Run Rate</div>
                    </div>
                </div>
                
                <div class="section-title">Recent Overs</div>
                <div class="recent-overs" id="recent-overs"></div>
                
                <div class="section-title">Last Wicket</div>
                <div id="last-wicket"></div>
                
                <div class="section-title">Commentary</div>
                <div class="commentary-container" id="commentary"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Get match ID from URL parameters
        const matchId = getUrlParameter('id') || 'default-match';
        
        // Update the page title based on the match ID
        document.getElementById('match-title').textContent = `Live Match: ${matchId}`;
        
        // State variables
        let matchData = null;
        let loading = true;
        let error = null;
        let runRateChart = null;
        let manhattanChart = null;
        let wicketsChart = null;
        
        // Helper functions
        function setLoading(isLoading) {
            loading = isLoading;
            document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
            document.getElementById('match-content').style.display = isLoading ? 'none' : 'block';
        }
        
        function setError(errorMessage) {
            error = errorMessage;
            document.getElementById('error').style.display = errorMessage ? 'block' : 'none';
            document.getElementById('error').textContent = errorMessage || '';
        }
        
        function setMatchData(data) {
            matchData = data;
        }
        
        // Calculate win probability based on match situation
        function calculateWinProbability(matchData) {
            if (!matchData || !matchData.currentInnings || matchData.currentInnings !== 2) {
                return { team1: 50, team2: 50 }; // Default to 50-50 if not in second innings
            }
            
            const totalBalls = 120; // T20 match
            const runsNeeded = matchData.runsNeeded || 0;
            const ballsRemaining = matchData.ballsRemaining || 0;
            const wicketsLost = matchData.team2.score ? parseInt(matchData.team2.score.split('/')[1]) || 0 : 0;
            const target = matchData.target || 0;
            
            // Factors that influence win probability
            const ballsUsed = totalBalls - ballsRemaining;
            const runRate = ballsUsed > 0 ? ((target - runsNeeded) / (ballsUsed / 6)).toFixed(2) : 0;
            const reqRunRate = ballsRemaining > 0 ? ((runsNeeded / (ballsRemaining / 6))).toFixed(2) : 999;
            
            // Simple model: consider required run rate, wickets lost, and balls remaining
            let battingTeamProb = 50;
            
            // Adjust based on required run rate (higher RRR = lower probability)
            if (reqRunRate > 12) battingTeamProb -= 30;
            else if (reqRunRate > 10) battingTeamProb -= 20;
            else if (reqRunRate > 8) battingTeamProb -= 10;
            else if (reqRunRate < 6) battingTeamProb += 20;
            
            // Adjust based on wickets lost (more wickets = lower probability)
            battingTeamProb -= wicketsLost * 5;
            
            // Adjust based on balls remaining (fewer balls = lower probability)
            if (ballsRemaining < 12) battingTeamProb -= 15;
            else if (ballsRemaining < 24) battingTeamProb -= 5;
            
            // Ensure probability is between 0 and 100
            battingTeamProb = Math.max(0, Math.min(100, battingTeamProb));
            
            // For first innings team
            const bowlingTeamProb = 100 - battingTeamProb;
            
            return {
                team1: matchData.currentInnings === 2 ? bowlingTeamProb : battingTeamProb,
                team2: matchData.currentInnings === 2 ? battingTeamProb : bowlingTeamProb
            };
        }
        
        // Generate over-by-over runs data for Manhattan chart
        function generateManhattanData(matchData) {
            if (!matchData || !matchData.recentOvers) {
                return { labels: [], data: [] };
            }
            
            // Extract data from recent overs
            const recentOvers = matchData.recentOvers || [];
            const labels = recentOvers.map(over => `Over ${over.over}`);
            const data = recentOvers.map(over => over.runs);
            
            // Add some mock historical data to make the chart more interesting
            // In a real app, this would come from the API
            const mockOvers = [];
            const startOver = Math.max(1, (recentOvers[0]?.over || 16) - 12);
            
            for (let i = startOver; i < (recentOvers[0]?.over || 16); i++) {
                mockOvers.push({
                    over: i,
                    runs: Math.floor(Math.random() * 15) + 1 // Random runs between 1-15
                });
            }
            
            // Combine mock data with real data
            const allLabels = [...mockOvers.map(over => `Over ${over.over}`), ...labels];
            const allData = [...mockOvers.map(over => over.runs), ...data];
            
            return { labels: allLabels, data: allData };
        }
        
        // Generate data for wickets chart
        function generateWicketsData(matchData) {
            // In a real app, this would come from the API with full wicket history
            // For now, we'll create mock data based on the last wicket
            const wickets = [];
            
            if (matchData && matchData.lastWicket) {
                const lastWicketOver = matchData.lastWicket.over;
                const [overs, balls] = lastWicketOver.split('.').map(Number);
                const lastWicketBall = overs * 6 + (balls || 0);
                
                // Add the last wicket
                wickets.push({
                    ball: lastWicketBall,
                    player: matchData.lastWicket.player,
                    score: matchData.lastWicket.score,
                    dismissal: matchData.lastWicket.dismissal
                });
                
                // Add some mock previous wickets
                const totalWickets = parseInt(matchData.team2.score?.split('/')[1] || '1');
                
                for (let i = 1; i < totalWickets; i++) {
                    const wicketBall = Math.floor(Math.random() * lastWicketBall * 0.8); // Random ball before the last wicket
                    wickets.push({
                        ball: wicketBall,
                        player: `Player ${i}`,
                        score: Math.floor(Math.random() * 30) + 5,
                        dismissal: 'b Bowler'
                    });
                }
            }
            
            // Sort wickets by ball
            wickets.sort((a, b) => a.ball - b.ball);
            
            return wickets;
        }
        
        // Update the UI with match data
        function updateUI(data) {
            if (!data) return;
            
            // Update match header
            document.getElementById('match-title').textContent = data.title || '';
            document.getElementById('match-venue').textContent = data.venue || '';
            document.getElementById('match-date').textContent = data.date || '';
            document.getElementById('match-status').textContent = data.status || '';
            
            // Update team information
            document.getElementById('team1-name').textContent = data.team1?.name || '';
            document.getElementById('team1-score').textContent = data.team1?.score || '';
            document.getElementById('team1-overs').textContent = data.team1?.overs ? `(${data.team1.overs})` : '';
            
            document.getElementById('team2-name').textContent = data.team2?.name || '';
            document.getElementById('team2-score').textContent = data.team2?.score || '';
            document.getElementById('team2-overs').textContent = data.team2?.overs ? `(${data.team2.overs})` : '';
            
            // Update team short names for win probability
            document.getElementById('team1-short').textContent = data.team1?.shortName || '';
            document.getElementById('team2-short').textContent = data.team2?.shortName || '';
            
            // Update toss information
            if (data.toss) {
                document.getElementById('toss-info').textContent = `Toss: ${data.toss.winner} won and chose to ${data.toss.decision}`;
            }
            
            // Update target information
            if (data.currentInnings === 2 && data.target) {
                document.getElementById('target-info').innerHTML = `
                    <strong>Target:</strong> ${data.target} | 
                    <strong>Needs:</strong> ${data.runsNeeded} runs from ${data.ballsRemaining} balls | 
                    <strong>RRR:</strong> <span class="required-rate">${data.requiredRunRate}</span>
                `;
            } else {
                document.getElementById('target-info').textContent = '';
            }
            
            // Update batters table
            const battersTable = document.getElementById('batters-table');
            battersTable.innerHTML = '';
            
            if (data.currentBatters && data.currentBatters.length > 0) {
                data.currentBatters.forEach(batter => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${batter.name || ''}</td>
                        <td>${batter.runs || 0}</td>
                        <td>${batter.balls || 0}</td>
                        <td>${batter.fours || 0}</td>
                        <td>${batter.sixes || 0}</td>
                        <td>${batter.strikeRate || 0}</td>
                    `;
                    battersTable.appendChild(row);
                });
            }
            
            // Update bowler table
            const bowlerTable = document.getElementById('bowler-table');
            bowlerTable.innerHTML = '';
            
            if (data.currentBowler) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.currentBowler.name || ''}</td>
                    <td>${data.currentBowler.overs || 0}</td>
                    <td>${data.currentBowler.maidens || 0}</td>
                    <td>${data.currentBowler.runs || 0}</td>
                    <td>${data.currentBowler.wickets || 0}</td>
                    <td>${data.currentBowler.economy || 0}</td>
                `;
                bowlerTable.appendChild(row);
            }
            
            // Update partnership information
            if (data.partnership) {
                document.getElementById('partnership-runs').textContent = data.partnership.runs || 0;
                document.getElementById('partnership-balls').textContent = data.partnership.balls || 0;
                
                // Calculate partnership run rate
                const partnershipBalls = data.partnership.balls || 0;
                const partnershipRuns = data.partnership.runs || 0;
                const partnershipRate = partnershipBalls > 0 ? (partnershipRuns / (partnershipBalls / 6)).toFixed(2) : '0.00';
                document.getElementById('partnership-rate').textContent = partnershipRate;
            }
            
            // Update recent overs
            const recentOversContainer = document.getElementById('recent-overs');
            recentOversContainer.innerHTML = '';
            
            if (data.recentOvers && data.recentOvers.length > 0) {
                data.recentOvers.forEach(over => {
                    const overBox = document.createElement('div');
                    overBox.className = 'over-box';
                    overBox.innerHTML = `
                        <div class="over-number">Over ${over.over}</div>
                        <div class="over-details">${over.details || ''}</div>
                        <div class="over-runs">${over.runs} runs${over.wickets ? `, ${over.wickets} wicket${over.wickets > 1 ? 's' : ''}` : ''}</div>
                    `;
                    recentOversContainer.appendChild(overBox);
                });
            }
            
            // Update last wicket information
            const lastWicketContainer = document.getElementById('last-wicket');
            
            if (data.lastWicket) {
                lastWicketContainer.innerHTML = `
                    <strong>${data.lastWicket.player}</strong> ${data.lastWicket.score} 
                    <span style="color: #666;">(${data.lastWicket.dismissal})</span> 
                    at <strong>${data.lastWicket.over}</strong>
                `;
            } else {
                lastWicketContainer.textContent = 'No wickets yet';
            }
            
            // Update commentary
            const commentaryContainer = document.getElementById('commentary');
            commentaryContainer.innerHTML = '';
            
            if (data.commentary && data.commentary.length > 0) {
                data.commentary.forEach(comment => {
                    const commentItem = document.createElement('div');
                    commentItem.className = 'commentary-item';
                    commentItem.innerHTML = `
                        <span class="commentary-over">${comment.over}</span>
                        ${comment.text}
                    `;
                    commentaryContainer.appendChild(commentItem);
                });
            }
            
            // Update run rate values
            if (data.currentInnings === 2) {
                // Calculate current run rate
                const team2Score = parseInt(data.team2.score?.split('/')[0] || '0');
                const team2Overs = parseFloat(data.team2.overs || '0');
                const currentRR = team2Overs > 0 ? (team2Score / team2Overs).toFixed(2) : '0.00';
                
                document.getElementById('current-rr').textContent = currentRR;
                document.getElementById('required-rr').textContent = data.requiredRunRate || '0.00';
                
                // Calculate projected score
                const ballsRemaining = data.ballsRemaining || 0;
                const projectedAdditionalRuns = ballsRemaining / 6 * parseFloat(currentRR);
                const projectedScore = team2Score + Math.round(projectedAdditionalRuns);
                document.getElementById('projected-score').textContent = projectedScore;
            }
            
            // Update visualizations
            updateVisualizations(data);
        }
        
        // Update all visualizations
        function updateVisualizations(data) {
            // Update win probability
            updateWinProbability(data);
            
            // Update run rate chart
            updateRunRateChart(data);
            
            // Update manhattan chart
            updateManhattanChart(data);
            
            // Update wickets timeline and chart
            updateWicketsVisualization(data);
        }
        
        // Update win probability visualization
        function updateWinProbability(data) {
            const winProb = calculateWinProbability(data);
            
            // Update the win probability bar
            const team1Prob = document.getElementById('team1-win-prob');
            const team2Prob = document.getElementById('team2-win-prob');
            
            team1Prob.style.width = `${winProb.team1}%`;
            team1Prob.textContent = `${Math.round(winProb.team1)}%`;
            
            team2Prob.style.width = `${winProb.team2}%`;
            team2Prob.textContent = `${Math.round(winProb.team2)}%`;
        }
        
        // Update run rate chart
        function updateRunRateChart(data) {
            if (!data) return;
            
            // Calculate current and required run rates for the chart
            const currentRR = parseFloat(document.getElementById('current-rr').textContent) || 0;
            const requiredRR = parseFloat(document.getElementById('required-rr').textContent) || 0;
            
            // Create or update the chart
            const ctx = document.getElementById('runRateChart').getContext('2d');
            
            if (runRateChart) {
                runRateChart.destroy();
            }
            
            runRateChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Current RR', 'Required RR'],
                    datasets: [{
                        label: 'Run Rate',
                        data: [currentRR, requiredRR],
                        backgroundColor: [
                            '#3498db',
                            requiredRR > currentRR ? '#e74c3c' : '#2ecc71'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(15, Math.ceil(Math.max(currentRR, requiredRR)))
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Update manhattan chart
        function updateManhattanChart(data) {
            if (!data) return;
            
            const manhattanData = generateManhattanData(data);
            const ctx = document.getElementById('manhattanChart').getContext('2d');
            
            if (manhattanChart) {
                manhattanChart.destroy();
            }
            
            manhattanChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: manhattanData.labels,
                    datasets: [{
                        label: 'Runs',
                        data: manhattanData.data,
                        backgroundColor: manhattanData.data.map(runs => {
                            if (runs >= 15) return '#e74c3c'; // Red for big overs
                            if (runs >= 10) return '#f39c12'; // Orange for good overs
                            return '#3498db'; // Blue for normal overs
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 20
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Update wickets timeline and chart
        function updateWicketsVisualization(data) {
            if (!data) return;
            
            // Update wickets timeline
            const wicketsData = generateWicketsData(data);
            const timelineContainer = document.getElementById('wickets-timeline');
            
            // Clear existing markers (except the timeline line)
            Array.from(timelineContainer.children).forEach(child => {
                if (!child.classList.contains('timeline-line')) {
                    child.remove();
                }
            });
            
            // Add wicket markers
            const totalBalls = 120; // T20 match
            wicketsData.forEach((wicket, index) => {
                const marker = document.createElement('div');
                marker.className = 'wicket-marker';
                marker.textContent = (index + 1).toString();
                
                // Position marker based on ball number
                const position = (wicket.ball / totalBalls) * 100;
                marker.style.left = `${position}%`;
                
                // Add tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'wicket-tooltip';
                tooltip.textContent = `${wicket.player} ${wicket.score} (${wicket.dismissal})`;
                marker.appendChild(tooltip);
                
                timelineContainer.appendChild(marker);
            });
            
            // Update wickets chart
            const ctx = document.getElementById('wicketsChart').getContext('2d');
            
            if (wicketsChart) {
                wicketsChart.destroy();
            }
            
            // Convert ball numbers to over numbers for the chart
            const wicketOvers = wicketsData.map(wicket => (wicket.ball / 6).toFixed(1));
            const wicketScores = wicketsData.map(wicket => wicket.score);
            
            wicketsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: wicketOvers,
                    datasets: [{
                        label: 'Score at Wicket',
                        data: wicketScores,
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        borderColor: '#e74c3c',
                        borderWidth: 2,
                        pointBackgroundColor: '#e74c3c',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Overs'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Team Score'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    return `Wicket ${index + 1}: ${wicketsData[index].player}`;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    return [
                                        `Score: ${wicketsData[index].score}`,
                                        `Dismissal: ${wicketsData[index].dismissal}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Fetch match data from the API
        async function fetchMatchData() {
            try {
                setLoading(true);
                setError(null);
                
                const timestamp = new Date().getTime();
                // Use a dedicated endpoint that won't conflict with patterns
                const response = await fetch(`/api/live-cricket-match?t=${timestamp}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch match data: ${response.status} ${response.statusText}`);
                }
                
                const matchData = await response.json();
                console.log('Received match data:', matchData);
                
                if (!matchData || matchData.error) {
                    throw new Error(matchData.error || 'Invalid match data received');
                }
                
                setMatchData(matchData);
                updateUI(matchData);
                
                // Set up auto-refresh based on match status
                if (matchData.isEnded) {
                    console.log('Match has ended. No further refreshes needed.');
                    // Display a message that the match has ended
                    document.getElementById('refresh-status').textContent = 'Match has ended. No further updates available.';
                    document.getElementById('refresh-status').style.display = 'block';
                } else if (matchData.isLive) {
                    console.log('Match is live. Setting refresh for 30 seconds.');
                    document.getElementById('refresh-status').textContent = 'Match is live. Auto-refreshing every 30 seconds.';
                    document.getElementById('refresh-status').style.display = 'block';
                    setTimeout(fetchMatchData, 30000);
                } else {
                    console.log('Match is not live yet. Setting refresh for 2 minutes.');
                    document.getElementById('refresh-status').textContent = 'Match is not live yet. Checking for updates every 2 minutes.';
                    document.getElementById('refresh-status').style.display = 'block';
                    setTimeout(fetchMatchData, 120000);
                }
            } catch (error) {
                console.error('Error fetching match data:', error);
                setError('Failed to fetch match data. Please try again later.');
                document.getElementById('match-content').style.display = 'none';
                // Even on error, try again after 1 minute
                setTimeout(fetchMatchData, 60000);
            } finally {
                setLoading(false);
            }
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch match data when the page loads
            fetchMatchData();
            
            // Set up refresh button
            document.getElementById('refresh-button').addEventListener('click', function() {
                fetchMatchData();
            });
        });
    </script>
</body>
</html>
